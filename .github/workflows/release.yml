name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: Linux
            eb_args: --linux --x64
          - os: macos-latest
            label: macOS (arm64)
            eb_args: --mac --arm64
          - os: windows-latest
            label: Windows
            eb_args: --win --x64

    name: ${{ matrix.label }}
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CMake + Ninja (macOS)
        if: runner.os == 'macOS'
        run: brew install cmake ninja

      - name: Set version from tag
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          node -e "
            const fs = require('fs');
            const p = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            p.version = '${VERSION}';
            fs.writeFileSync('package.json', JSON.stringify(p, null, 2) + '\n');
          "

      # cmake-js auto-detects Visual Studio on Windows and explicitly passes
      # -G "Visual Studio 17 2022", ignoring CMAKE_GENERATOR env. That triggers
      # the library's MSVC branch which fetches pthreads4w — broken upstream.
      # Fix: install Node deps without running postinstall, then build the
      # native addon manually with Ninja + MinGW (pre-installed in MSYS2).
      - name: Add MinGW to PATH (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: echo "C:/msys64/mingw64/bin" >> $GITHUB_PATH

      - name: Install Node dependencies
        shell: bash
        run: npm install --ignore-scripts

      - name: Build native addon (Linux / macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: npx cmake-js build

      - name: Build native addon (Windows — MinGW + Ninja)
        if: runner.os == 'Windows'
        shell: bash
        run: npx cmake-js build --generator "Ninja"
        env:
          CC: gcc
          CXX: g++

      - name: Package and publish
        shell: bash
        run: npx electron-builder ${{ matrix.eb_args }} --publish always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Skip macOS code-signing (no Apple Developer certificate in CI).
          # Users opening the dmg for the first time must right-click → Open.
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
