name: Bump protocol and tag

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Build native addon (fetches latest protocol)
        run: npx cmake-js build

      - name: Determine next tag
        id: next_tag
        run: |
          latest=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
          if [ -z "$latest" ]; then
            next="v1.0.0"
          else
            patch=$(echo "$latest" | awk -F. '{print $3}')
            next=$(echo "$latest" | awk -F. -v p="$((patch+1))" '{print $1"."$2"."p}')
          fi
          echo "tag=$next" >> "$GITHUB_OUTPUT"
          echo "Next tag: $next"

      - name: Push tag
        run: |
          git tag "${{ steps.next_tag.outputs.tag }}"
          git push origin "${{ steps.next_tag.outputs.tag }}"
